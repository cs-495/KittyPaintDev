<html><head>
    <title>KittyPaint!</title>
    
    <!-- cool -->
    <meta content='width=device-width; initial-scale=1.0; maximum-scale=1.0; user-scalable=0;' name='viewport' />
    <meta name="viewport" content="width=device-width" />
    
    <style type="text/css">
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
        }
        canvas {
            display: block;
            //border:1px solid black;
            border: 0px;
        }
        .drawr_ui {
            padding: 5px;
            border: solid black;
            border-width: 1px;
            margin: 1px;
            background: #DEDECE;
            
            position: absolute;
            opacity: 0.8;
            filter:alpha(opacity:80);
            
            top: 15px;
            left: 15px;
            right: 15px;
            
            //border-width: 0px 0px 1px 0px;
            //top: 0px;
            //left: 0px;
            //right: 0px;
        }
        .drawr_ui:hover {
            opacity: 1.0;
            filter:alpha(opacity:100);
        }
        .server_box {
            background-color: #FFFFFF;
            border: 1px solid black;
            padding: 1px;
        }
        .server_box:focus {
            background-color: #D7EFFF;
        }
        .button_holder {
            float:left;
            margin: 0px 10px;
        }
		.select_box{
			width: 32px;
			height: 32px;
			border: solid black 1px;
			color: black;
			float:left;
			margin-right:3px;
			margin-bottom:3px;
			cursor:pointer;
		}
		.selected_box{
			width: 32px;
			height: 32px;
			border: solid white 1px;
			color: black;
			float:left;
			margin-right:3px;
			margin-bottom:3px;
			cursor:pointer;
		}
		.disabled_select_box{
			width: 32px;
			height: 32px;
			border: solid #A0A0A0 1px;
			color: #A0A0A0;
			float:left;
			margin-right:3px;
			margin-bottom:3px;
		}
        
        canvas {
            image-rendering: optimizeSpeed;             // Older versions of FF
            image-rendering: -moz-crisp-edges;          // FF 6.0+
            image-rendering: -webkit-optimize-contrast; // Webkit
                                                        //  (Safari now, Chrome soon)
            image-rendering: -o-crisp-edges;            // OS X & Windows Opera (12.02+)
            image-rendering: optimize-contrast;         // Possible future browsers.
            -ms-interpolation-mode: nearest-neighbor;   // IE
        }
    </style>
</head>
<body>

    <center>
    
        <div class="drawr_ui">
            <!-- hide into small box in topleft screen, if small screen? toggle on click/timeout -->
            <div class="button_holder">
                <!--input type="button" value="hello" onClick="showAndroidToast('Welcome 2 DRAWR!');" / -->
                <!--<input type="button" value="add obj" onClick="add_one();" /> | 
                <input type="button" value="update: on" id="toggle_update" onClick="toggle_update();" disabled /> | 
                <input type="button" value="update" onClick="update();" disabled /> | 
                <input type="button" value="clear" onClick="clear_drawr();"/>
                <br/>-->
				<a href="#" style="float:left;margin-right:3px;" onClick="prevBrushPage(); return false;">&lt;&lt;</a>
                <div class="select_box" id="brush_box0" onClick="selectBrush(0);"></div>
				<div class="select_box" id="brush_box1" onClick="selectBrush(1);"></div>
				<div class="select_box" id="brush_box2" onClick="selectBrush(2);"></div>
				<div class="select_box" id="brush_box3" onClick="selectBrush(3);"></div>
				<div class="select_box" id="brush_box4" onClick="selectBrush(4);"></div>
				<div class="select_box" id="brush_box5" onClick="selectBrush(5);"></div>
				<div class="select_box" id="brush_box6" onClick="selectBrush(6);"></div>
				<div class="select_box" id="brush_box7" onClick="selectBrush(7);"></div>
				<div class="select_box" id="brush_box8" onClick="selectBrush(8);"></div>
				<div class="select_box" id="brush_box9" onClick="selectBrush(9);"></div>
				<a href="#" onClick="nextBrushPage(); return false;">&gt;&gt;</a>
				
				<br/>
				<div class="select_box" id="size_box0" onClick="selectBrushSize(0,1);">1</div>
				<div class="select_box" id="size_box1" onClick="selectBrushSize(1,4);">4</div>
				<div class="select_box" id="size_box2" onClick="selectBrushSize(2,8);">8</div>
				<div class="select_box" id="size_box3" onClick="selectBrushSize(3,16);">16</div>
				<div class="select_box" id="size_box4" onClick="selectBrushSize(4,32);">32</div>
		
				<span>Zoom: </span>
				<select id="zoom_list" onchange="select_zoom();">
					<option>0.5</option>
					<option>1</option>
					<option>2</option>
					<option>4</option>
					<option>8</option>
					<option>16</option>
				</select>
				<select style="visibility:hidden;" id="brush_list" onchange="select_brush();">
                </select>
				<select style="visibility:hidden;" id="color_list" onchange="select_brush();">
				</select>
            </div>
            <div class="button_holder">
                Drawr Server: <input type="text" id="server_url" class="server_box" value="http://127.0.0.1:27182"/>
                <!--br/>
                Room: <input type="text" id="room" class="server_box" value="testroom"/-->
            </div>
            <div class="button_holder" style="overflow-y:scroll;height:3em;border: 1px solid black;">
                <div id="debug">-<br/>-<br/>-</div>
            </div>
        </div>

        <canvas id="kittycanvas">
            Pls upgrade browser
        </canvas>
    
    </center>

</body>

<script type="text/javascript" src="utils.js"></script>
<script type="text/javascript" src="drawr_brushes.js"></script>
<script type="text/javascript" src="drawr_map.js"></script>
<script type="text/javascript" src="network.js"></script>
<script type="text/javascript" src="drawr.js"></script>
<script type="text/javascript" src="drawr_input.js"></script>

<script type="text/javascript">
    var num_brush_boxes = 10;
	var brush_box_page = 0;
	var num_brush_box_pages = 0;
	var brush_boxes = [];
	var num_size_boxes = 5;
	var size_boxes = [];
	var current_brushes = [];
	var brush_index = 0;
	var brush_size_index = 3;
	var brush_size = 16;
	
    var brushes = new DrawrBrushes(function(){  // maybe we need a loading screen for this
		//Load Brushes
		num_brush_box_pages = Math.ceil(brushes.getBrushes().length/num_brush_boxes);
		for (var i=0; i<num_brush_boxes;++i){
			brush_boxes[i] = document.getElementById("brush_box"+i);
		}
		for (var i=0; i<num_size_boxes;++i){
			size_boxes[i] = document.getElementById("size_box"+i);
		}
		setBrushBoxes();
		
		document.getElementById("zoom_list").selectedIndex = 2;
    });
    
    var drawr = new KittyDrawr("kittycanvas", brushes, "debug");
    

    function showAndroidToast(toast) {
        Android.showToast(toast);
    }
	
	function selectBrush(index){
		for (var i=0; i<current_brushes.length;++i){
			brush_boxes[i].className = "select_box";
		}
		if (index < current_brushes.length){
			console.log(current_brushes[index].name);
			brushes.selectBrush(index+(num_brush_boxes*brush_box_page));
			brush_boxes[index].className = "selected_box";
			brush_index = index;
		}
	
		fixBrushSize();
	}
	
	function fixSelectedBrush(){
		if (brush_index >= current_brushes.length){
			for (var i=0; i<brush_boxes.length;++i){
				if (i < current_brushes.length){
					brush_index = i;
				}else{
					brush_boxes[i].className = "disabled_select_box";
				}
			}
		}
	}
	
	function fixBrushSize(){
		for (var i=0; i<size_boxes.length; ++i){
			size_boxes[i].className = "select_box";
		}
		var brush = brushes.getBrush();
		if (brush.type == "stamp"){
			var index = 1;
			size_boxes[0].className = "disabled_select_box";
			if (brush.size >= 8){ 
				index = 2;
				size_boxes[1].className = "disabled_select_box";
			}
			if (brush.size >= 16){ 
				index = 3;
				size_boxes[2].className = "disabled_select_box";
			}
			if (brush.size >= 32){ 
				index = 4;
				size_boxes[3].className = "disabled_select_box";
			}
		
			if (brush_size < brush.size){
				brush_size = brush.size;
				brush_size_index = index;
			}
		}
		selectBrushSize(brush_size_index, brush_size);
	}
	
	function selectBrushSize(index, size){
		var brush = brushes.getBrush();
		if (brush.type == "stamp"){
			if (size < brush.size) return;
		}
		
		for (var i=0; i<size_boxes.length;++i){
			if (size_boxes[i].className != "disabled_select_box")
				size_boxes[i].className = "select_box";
		}
		size_boxes[index].className = "selected_box";
		brush_size_index = index;
		brush_size = size;
		brushes.setBrushSize(size);
	}
	
	function select_zoom(){
		var zoom = document.getElementById("zoom_list").value;
		drawr.changePixelScale(zoom);
		drawr.loadNearbyChunks();
		document.getElementById("zoom_list").blur();
        document.getElementById("kittycanvas").focus();
	}
    
    function get_server(){
        server = document.getElementById("server_url").value;
        if(!server.match(/^http:\/\//)) server = "http://" + server;
        document.getElementById("server_url").value = server;
        return server;
    }
    
    function get_room(){
        return document.getElementById("room").value.replace(/\&/, "");
    }
	
	function setBrushBoxes(){
		current_brushes = [];
		var brush_list = brushes.getBrushes();
		for (var i=0; i<num_brush_boxes;++i){
			var real_brush_index = i+(num_brush_boxes*brush_box_page);
			if (real_brush_index < brush_list.length){
				var brush = brush_list[real_brush_index];
				current_brushes.push(brush);
				
				if (brush.type == "brush"){
					brush_boxes[i].style.background = "url('"+brush.sizes[4].img.src+"')  no-repeat center";
				}else if (brush.type == "stamp"){
					brush_boxes[i].style.background = "url('"+brush.img.src+"') no-repeat center";
				}
			}else{
				brush_boxes[i].style.backgroundColor = "";
				brush_boxes[i].style.background = "";
			}
		}
		fixSelectedBrush();
		selectBrush(brush_index);
		selectBrushSize(brush_size_index, brush_size);
	}
	
	function prevBrushPage(){
		brush_box_page--;
		if (brush_box_page < 0) brush_box_page = num_brush_box_pages-1;
		setBrushBoxes();
	}
	
	function nextBrushPage(){
		brush_box_page++;
		if (brush_box_page >= num_brush_box_pages) brush_box_page = 0;
		setBrushBoxes();
	}
    
    
    
    
    
    
    
    var newest_id = -1;
    
    function makeobjo(){
        r = function(){ return Math.floor(Math.random()*10 - 5); }
        objo = new DrawrPath();
        objo.addPoint(25+r(),25+r(),100,100);
        objo.addPoint(34+r(),30+r(),100,100);
        objo.addPoint(87+r(),54+r(),100,100);
        objo.addPoint(10+r(),54+r(),100,100);
        objo.addPoint(90+r(),78+r(),100,100);
        return objo;//.serialize();
    }
    function add_one(){
        /*url_post = get_server() + "/post?" + get_room() + "&" + makeobjo();
        loadJSON(url_post, function(jsonObj){
            newest_id = 1 * jsonObj;
            debug.innerHTML += "id: " + newest_id + ",";
        });*/
        drawrObjects.push(makeobjo());
    }
    
    var do_updatingu = 1;
    function toggle_update(){
        do_updatingu = !do_updatingu;
        document.getElementById("toggle_update").value = "update: " + (do_updatingu ? "on" : "off");
    }
    
    function update(){
        if(!do_updatingu) return;
        loadJSON(get_server() + "/get?" + get_room() + "&-1", function(jsonObj){
            debug.innerHTML = JSON.stringify(jsonObj);
            
            // since requesting from -1
            drawrObjects = [];
            for(var i=0; i<jsonObj.length; ++i){
                drawrObjects.push(DrawrPath.fromJSON(jsonObj[i]));
            }
        });
    }
    
    function clear_drawr(){
        url_post = get_server() + "/clear?" + get_room();
        loadJSON(url_post, function(jsonObj){
            if(jsonObj*1 == 0){
                drawrObjects = [];
                debug.innerHTML = "";
            }
        });
    }
    
    //////////////////////////////////////////setInterval(update, 500);
</script>
</html>