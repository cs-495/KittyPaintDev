<html><head>
    <title>KittyPaint!</title>
    
    <!-- cool -->
    <meta content='width=device-width; initial-scale=1.0; maximum-scale=1.0; user-scalable=0;' name='viewport' />
    <meta name="viewport" content="width=device-width" />
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"/>
    
    <style type="text/css">
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
        }
        #kittycanvas {
            display: block;
            //border:1px solid black;
            border: 0px;
        }
        .drawr_ui {
            padding: 5px;
            border: solid black;
            border-width: 1px;
            margin: 1px;
            background: #DEDECE;
            
            position: absolute;
            opacity: 0.8;
            filter:alpha(opacity:80);
            
            top: 15px;
            left: 15px;
            
            //border-width: 0px 0px 1px 0px;
            //top: 0px;
            //left: 0px;
            //right: 0px;
        }
        .drawr_ui:hover {
            opacity: 1.0;
            filter:alpha(opacity:100);
        }
        .server_box {
            background-color: #FFFFFF;
            border: 1px solid black;
            padding: 1px;
        }
        .server_box:focus {
            background-color: #D7EFFF;
        }
        .button_holder {
            float:left;
            margin: 0px 10px;
        }
        .arrow_box{
			width: 32px;
			height: 32px;
            line-height:32px;
            text-align: center;
            padding: 1px;
            float: left;
        }
		.select_box{
			width: 32px;
			height: 32px;
			border: solid black 1px;
			color: black;
			float:left;
			margin-right:3px;
			margin-bottom:3px;
			cursor:pointer;
            line-height: 32px;
		}
		.color_pick_part{
			float:left;
			margin-right:3px;
			margin-bottom:3px;
			height:32px;
		}
		.selected_box{
			width: 32px;
			height: 32px;
			border: solid white 1px;
			color: black;
			float:left;
			margin-right:3px;
			margin-bottom:3px;
			cursor:pointer;
            line-height: 32px;
		}
		.disabled_select_box{
			width: 32px;
			height: 32px;
			border: solid #A0A0A0 1px;
			color: #A0A0A0;
			float:left;
			margin-right:3px;
			margin-bottom:3px;
            line-height: 32px;
		}
        .position_box {
            background-color: #FFF;
            border: 1px solid black;
            width: 150px;
            margin: 1px;
        }
        canvas {
            image-rendering: optimizeSpeed;             // Older versions of FF
            image-rendering: -moz-crisp-edges;          // FF 6.0+
            image-rendering: -webkit-optimize-contrast; // Webkit
                                                        //  (Safari now, Chrome soon)
            image-rendering: -o-crisp-edges;            // OS X & Windows Opera (12.02+)
            image-rendering: optimize-contrast;         // Possible future browsers.
            -ms-interpolation-mode: nearest-neighbor;   // IE
        }
    </style>
</head>
<body>
    <center>
		<div id="minimized_ui" class="drawr_ui" style="width:35px;height:35px;display:none;" onClick="toggleMinimizeUI();">
			<div class="selected_box" id="minimized_brush_box">&nbsp;</div>
		</div>
        <div id="drawr_ui" class="drawr_ui">
            <!-- hide into small box in topleft screen, if small screen? toggle on click/timeout -->
            <div class="button_holder">
                <!--input type="button" value="hello" onClick="showAndroidToast('Welcome 2 DRAWR!');" / -->
                <!--<input type="button" value="add obj" onClick="add_one();" /> | 
                <input type="button" value="update: on" id="toggle_update" onClick="toggle_update();" disabled /> | 
                <input type="button" value="update" onClick="update();" disabled /> | 
                <input type="button" value="clear" onClick="clear_drawr();"/>
                <br/>-->
                <div style="overflow: auto;">
                    <a href="#" style="margin-right:3px;" class="arrow_box" onClick="prevBrushPage(); return false;">&lt;&lt;</a>
                    <div class="select_box" id="brush_box0" onClick="selectBrush(0);">&nbsp;</div>
                    <div class="select_box" id="brush_box1" onClick="selectBrush(1);">&nbsp;</div>
                    <div class="select_box" id="brush_box2" onClick="selectBrush(2);">&nbsp;</div>
                    <div class="select_box" id="brush_box3" onClick="selectBrush(3);">&nbsp;</div>
                    <div class="select_box" id="brush_box4" onClick="selectBrush(4);">&nbsp;</div>
                    <div class="select_box" id="brush_box5" onClick="selectBrush(5);">&nbsp;</div>
                    <div class="select_box" id="brush_box6" onClick="selectBrush(6);">&nbsp;</div>
                    <div class="select_box" id="brush_box7" onClick="selectBrush(7);">&nbsp;</div>
                    <div class="select_box" id="brush_box8" onClick="selectBrush(8);">&nbsp;</div>
                    <div class="select_box" id="brush_box9" onClick="selectBrush(9);">&nbsp;</div>
                    <a href="#" class="arrow_box" id="right_brush_arrow" onClick="nextBrushPage(); return false;">&gt;&gt;</a>
                    <!--span style="clear:both;">&nbsp;</span-->
					
					<!--<div class="small_select_box" onClick="toggleAdv();">+</div>
					<div class="small_select_box" onClick="toggleMinimizeUI();">-</div>-->
                </div>
				
				<div style="overflow: auto;">
					<div id="size_picker">
						<div class="select_box" id="size_box0" onClick="selectBrushSize(0,1);">1</div>
						<div class="select_box" id="size_box1" onClick="selectBrushSize(1,4);">4</div>
						<div class="select_box" id="size_box2" onClick="selectBrushSize(2,8);">8</div>
						<div class="select_box" id="size_box3" onClick="selectBrushSize(3,16);">16</div>
						<div class="select_box" id="size_box4" onClick="selectBrushSize(4,32);">32</div>
						<!--span style="clear:both;">&nbsp;</span-->
					</div>
					<div id="color_picker" style="line-height:32px;display:none;">
						<div class="color_pick_part">&nbsp;<b>R</b> 
							<input id="color_r" type="text" style="width:36px;text-align:right;" onkeypress="editColor();" onkeyup="editColor();">
                        </div>
						<div class="color_pick_part">&nbsp;<b>G</b> 
							<input id="color_g" type="text" style="width:36px;text-align:right;" onkeypress="editColor();" onkeyup="editColor();">
                        </div>
						<div class="color_pick_part">&nbsp;<b>B</b> 
							<input id="color_b" type="text" style="width:36px;text-align:right;margin-right:1px;" onkeypress="editColor();" onkeyup="editColor();">
                            &nbsp;
						</div>
					</div>
					<div class="select_box" id="color_box" onClick="toggleColorPicker();">
					</div>
					<div class="select_box" id="stamp_box" onClick="toggleStampUI();" 
						style="background: url('brushes/createstamp.png')"></div>
            
					<div style="line-height:32px;float:right;text-align:center;">
						<div>
						<span>Zoom: </span>
						<select id="zoom_list" onchange="select_zoom();">
							<option>0.5</option>
							<option>1</option>
							<option>2</option>
							<option>4</option>
							<option>8</option>
							<option>16</option>
						</select>
						&nbsp;
						<div style="display:inline;">
							<input type="button" value="&ndash;" id="toggle_min_tab" onClick="toggleMinimizeUI();"/>
							<input type="button" value="+" id="toggle_max_tab" onClick="toggleAdv();"/>
						</div>
						</div>
					</div>
                </div>
            </div>
			
            <span id="adv_tab" style="display:none;">
				<div class="button_holder">
					auto-hide ui: <input id="auto_hide_ui" type="checkbox" onClick="toggleAutoHideUI();">
				</div>
                <div class="button_holder">
                    server: <input type="text" id="server_url" class="server_box" value="127.0.0.1:27182"/>
                    <input type="button" value="connect" onClick="set_server();"/>
                </div>
				<br/>
				<div class="button_holder">
                    <input type="text" id="tele_waypoint" class="position_box" placeholder="Enter waypoint..."/>
                    <input type="button" value="go" onclick="teleport_go();"/>
				</div>
                <div class="button_holder" style="overflow-y:scroll;height:3em;border: 1px solid black;">
                    <div id="debug">-<br/>-<br/>-</div>
                </div>
            </span>
			
			<div id="edit_stamp_ui" style="display:none;">
				<canvas id="stampcanvas" oncontextmenu="return false;" style="margin-top:10px;border:solid black 1px;">
					Pls upgrade browser
				</canvas><br/><br/>
				<div style="display:inline;">
					<input type="button" value="Save" id="save_stamp" onClick="return false;"/>
					<input type="button" value="Clear" id="clear_stamp" onClick="return false;"/>
				</div>
			</div>
        </div>

        <canvas id="kittycanvas" oncontextmenu="return false;">
            Pls upgrade browser
        </canvas>
    
    </center>

</body>

<script type="text/javascript" src="utils.js"></script>
<script type="text/javascript" src="md5_crypt.js"></script>
<script type="text/javascript" src="drawr_brushes.js"></script>
<script type="text/javascript" src="drawr_map.js"></script>
<script type="text/javascript" src="stampdrawr.js"></script>
<script type="text/javascript" src="drawr_client.js"></script>
<script type="text/javascript" src="drawr.js"></script>
<script type="text/javascript" src="drawr_input.js"></script>

<script type="text/javascript">

    var num_brush_boxes = 10;
    var num_available_brush_boxes = 10;
	var brush_box_page = 0;
	var num_brush_box_pages = 0;
	var brush_boxes = [];
	var num_size_boxes = 5;
	var size_boxes = [];
	var current_brushes = [];
	var brush_index = 0;
	var brush_size_index = 2;
	var brush_size = 8;
	var auto_hide_ui = false;
	
	function toggleAutoHideUI(){
		auto_hide_ui = !auto_hide_ui;
	}
    
    for (var i=0; i<num_brush_boxes;++i){
        brush_boxes[i] = $("brush_box"+i);
    }
    for (var i=0; i<num_size_boxes;++i){
        size_boxes[i] = $("size_box"+i);
    }
    $("zoom_list").selectedIndex = 2;
    
    
	/******* SETUP *******/
    var brushes = new DrawrBrushes(function(){  // maybe we need a loading screen for this
		//Load Brushes
        num_brush_box_pages = Math.ceil(brushes.getBrushes().length/num_available_brush_boxes);
		setBrushBoxes();
    });
    
    var drawr_client = new DrawrClient("127.0.0.1:27182");
    
    var drawr = new KittyDrawr("kittycanvas", brushes, drawr_client, "debug");
	drawr.addEventListener("mapmove", update_position_box);
	
	var stampdrawr = new StampDrawr("stampcanvas", brushes, "debug");
    
    
    var default_onresize = window.onresize || function(){};
    window.onresize = function(){ ui_onresize(); default_onresize(); }
    ui_onresize();
    function ui_onresize(){
        // see if the line of brush boxes wraps around. if so, hide the ones that go too far past the edge, so it stays 1 row.
        var brush_box_row1 = $("brush_box0").offsetTop;
        var s = brush_box_row1 + " ";
        var count_row1_boxes = 1;
        for (var i=1; i<num_brush_boxes;++i){
			var thisbox_top = $("brush_box"+i).offsetTop;
            s += thisbox_top + " ";
            if(thisbox_top == 0 || $("brush_box"+i).style.display == "none"){
                // block is hidden, make it visible to check where its offset would be
                $("brush_box"+i).style.display = "block";
                thisbox_top = $("brush_box"+i).offsetTop;
            }
            if(thisbox_top == brush_box_row1){
                count_row1_boxes++;
                $("brush_box"+i).style.display = "block";
            }else{
                $("brush_box"+i).style.display = "none";
            }
		}
        //hide 1 more brush_box if the arrow button is moved to next line too!
        if($("right_brush_arrow").offsetTop != brush_box_row1){
            if(count_row1_boxes > 2){ // make sure we actually have a button to hide
                count_row1_boxes -= 1;
                $("brush_box"+count_row1_boxes).style.display = "none";
            }
        }
        
        num_available_brush_boxes = count_row1_boxes;
		num_brush_box_pages = Math.ceil(brushes.getBrushes().length/num_available_brush_boxes);
		setBrushBoxes();
    }

    function showAndroidToast(toast) {
        Android.showToast(toast);
    }
	
	function fixSelectedBrush(){
		if (brush_index >= current_brushes.length){
			for (var i=0; i<brush_boxes.length;++i){
				if (i < current_brushes.length){
					brush_index = i;
				}else{
					brush_boxes[i].className = "disabled_select_box";
				}
			}
		}else{
			for (var i=current_brushes.length-1; i < brush_boxes.length;++i){
				brush_boxes[i].className = "disabled_select_box";
			}
		}
	}
	
	function selectBrush(index){
		if (index >= current_brushes.length) return;
		for (var i=0; i<current_brushes.length;++i){
			brush_boxes[i].className = "select_box";
		}
		
		brushes.selectBrush(index+(num_available_brush_boxes*brush_box_page));
		brush_boxes[index].className = "selected_box";
		$("minimized_brush_box").style.background = brush_boxes[index].style.background;
		brush_index = index;
			
		fixBrushSize();
		fixBrushColorEdit();
        
        drawr_client.setBrush(brushes); // abstract this better maybe
	}
	
	function fixBrushSize(){
		for (var i=0; i<size_boxes.length; ++i){
			size_boxes[i].className = "select_box";
		}
		var brush = brushes.getBrush();
		if (brush.type == "stamp"){
			var index = 1;
			size_boxes[0].className = "disabled_select_box";
			if (brush.size >= 8){ 
				index = 2;
				size_boxes[1].className = "disabled_select_box";
			}
			if (brush.size >= 16){ 
				index = 3;
				size_boxes[2].className = "disabled_select_box";
			}
			if (brush.size >= 32){ 
				index = 4;
				size_boxes[3].className = "disabled_select_box";
			}
		
			if (brush_size < brush.size){
				brush_size = brush.size;
				brush_size_index = index;
			}
		}
		selectBrushSize(brush_size_index, brush_size);
	}
	
	function selectBrushSize(index, size){
		var brush = brushes.getBrush();
		if (brush.type == "stamp"){
			if (size < brush.size) return;
		}
		
		for (var i=0; i<size_boxes.length;++i){
			if (size_boxes[i].className != "disabled_select_box")
				size_boxes[i].className = "select_box";
		}
		size_boxes[index].className = "selected_box";
		brush_size_index = index;
		brush_size = size;
		brushes.setBrushSize(size);
	}
	
	function fixBrushColorEdit(){
		var edit_color = $("color_box");
		var brush = brushes.getBrush();
		if (brush.type == "brush"){
			edit_color.style.background = "url('brushes/editcolor.png')";
			edit_color.className = "select_box";
			
			$("color_r").value = brush.color.r;
			$("color_g").value = brush.color.g;
			$("color_b").value = brush.color.b;
		}else if (brush.type == "stamp"){
			edit_color.style.background = "url('brushes/editcolordisabled.png')";
			edit_color.className = "disabled_select_box";
			
			$("size_picker").style.display = "inline";
			$("color_picker").style.display = "none";
		}
	}
	
	function toggleColorPicker(){
		var brush = brushes.getBrush();
		if (brush.type == "stamp") return false;
		
		sp = $("size_picker");
		cp = $("color_picker");
		if (sp.style.display != "none"){
			sp.style.display = "none";
			cp.style.display = "inline";
            $("color_r").blur();
            $("color_g").blur();
            $("color_b").blur();
		}else{
			sp.style.display = "inline";
			cp.style.display = "none";
		}
	}
	
	function editColor(){
		var brush = brushes.getBrush();
		if (brush.type == "stamp") return false;		
		
		var r = $("color_r");
		var g = $("color_g");
		var b = $("color_b");
		
        r.value > 255 && (r.value = 255) || r.value < 0 && (r.value = 0);
        g.value > 255 && (g.value = 255) || g.value < 0 && (g.value = 0);
        b.value > 255 && (b.value = 255) || b.value < 0 && (b.value = 0);
        
        DrawrBrushes.setBrushColor(brush, r.value, g.value, b.value);
		$("minimized_brush_box").style.background = brush_boxes[index].style.background;
	}
	
	function select_zoom(){
		var zoom = $("zoom_list").value;
		drawr.changePixelScale(zoom);
		drawr.loadNearbyChunks();
		$("zoom_list").blur();
        $("kittycanvas").focus();
		
		if (zoom < 1){
			$("kittycanvas").style.cursor = "not-allowed";
		}else{ $("kittycanvas").style.cursor = "default";
		}
	}
	
	function setBrushBoxes(){
		current_brushes = [];
		var brush_list = brushes.getBrushes();
		for (var i=0; i<num_available_brush_boxes;++i){
			var real_brush_index = i+(num_available_brush_boxes*brush_box_page);
			if (real_brush_index < brush_list.length){
				var brush = brush_list[real_brush_index];
				current_brushes.push(brush);
				
				if (brush.type == "brush"){
                    brush_boxes[i].style.background = "url('" + brush.sized_images[4].src + "') no-repeat center";
				}else if (brush.type == "stamp"){
					brush_boxes[i].style.background = "url('"+brush.img.src+"') no-repeat center";
				}
			}else{
				brush_boxes[i].style.background = "";
			}
		}
		fixSelectedBrush();
		selectBrush(brush_index);
		selectBrushSize(brush_size_index, brush_size);
	}
	
	function prevBrushPage(){
		brush_box_page--;
		if (brush_box_page < 0) brush_box_page = num_brush_box_pages-1;
		setBrushBoxes();
	}
	
	function nextBrushPage(){
		brush_box_page++;
		if (brush_box_page >= num_brush_box_pages) brush_box_page = 0;
		setBrushBoxes();
	}
	
	function minimizeUI(){
		dui = $("drawr_ui");
		mdui = $("minimized_ui");
		if (dui.style.display != "none"){
			dui.style.display = "none";
			mdui.style.display = "block";
		}
	}
	
	function toggleStampUI(){
		if ($("edit_stamp_ui").style.display != "none"){
			$("edit_stamp_ui").style.display = "none";
		}else{
			$("edit_stamp_ui").style.display = "block";
		}
	}
	
	function toggleMinimizeUI(){
		a = $("adv_tab");
		if (a.style.display != "none"){
			a.style.display = "none";
		}else{
			dui = $("drawr_ui");
			mdui = $("minimized_ui");
			if (dui.style.display != "none"){
				dui.style.display = "none";
				mdui.style.display = "block";
			}else{
				dui.style.display = "block";
				mdui.style.display = "none";
			}
		}
	}
    
    function toggleAdv(){
        a = $("adv_tab");
        if(a.style.display != "none"){
            a.style.display = "none";
        }else{
            a.style.display = "inline";
        }
    }
    
    function teleport_go(){
        var waypointstr = $("tele_waypoint").value;
        if(waypointstr != ""){
            var rstr_loc = hex_md5(waypointstr);
            var hex_x = rstr_loc.substr(0,8);
            var hex_y = rstr_loc.substr(8,8);
            var x = parseInt(hex_x, 16) - 0xffffffff/2;
            var y = parseInt(hex_y, 16) - 0xffffffff/2;
            console.log(x + "," + y);
        }else{
            var x = 0;
            var y = 0;
        }
        
        drawr.drawr_map.setIngameOffsetX(x);
        drawr.drawr_map.setIngameOffsetY(y);
        drawr.loadNearbyChunks();
    }

    function update_position_box(){
        //$("tele_waypoint").value = "";
    }
    
    function set_server(){
        var server = $("server_url").value;
        if(!server.match(/^[^\/]$/)){
            server = drawr_client.server;
            $("server_url").value = server;
        }
        drawr_client.stop();
        drawr_client.server = server;
        drawr_client.start();
    }
    
    function get_room(){
        return $("room").value.replace(/\&/, "");
    }
    
    
    
    
    
    
    function add_one(){
        /*url_post = get_server() + "/post?" + get_room() + "&" + makeobjo();
        loadJSON(url_post, function(jsonObj){
            newest_id = 1 * jsonObj;
            debug.innerHTML += "id: " + newest_id + ",";
        });*/
        drawrObjects.push(makeobjo());
    }
    
    var do_updatingu = 1;
    function toggle_update(){
        do_updatingu = !do_updatingu;
        $("toggle_update").value = "update: " + (do_updatingu ? "on" : "off");
    }
    
    function update(){
        if(!do_updatingu) return;
        loadJSON(get_server() + "/get?" + get_room() + "&-1", function(jsonObj){
            debug.innerHTML = JSON.stringify(jsonObj);
            
            // since requesting from -1
            drawrObjects = [];
            for(var i=0; i<jsonObj.length; ++i){
                drawrObjects.push(DrawrPath.fromJSON(jsonObj[i]));
            }
        });
    }
    
    function clear_drawr(){
        url_post = get_server() + "/clear?" + get_room();
        loadJSON(url_post, function(jsonObj){
            if(jsonObj*1 == 0){
                drawrObjects = [];
                debug.innerHTML = "";
            }
        });
    }
    
    //////////////////////////////////////////setInterval(update, 500);
</script>
</html>